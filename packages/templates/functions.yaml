
################################################################################
## cr.list_packages_with_deps ###
################################################################################

{{- define "cr.list_packages_with_deps" }}

  {{- if not (default .skip false) }}

    {{- $packages := list }}

    {{- $dep := . }}

    {{- range ( "requires prerequires optrequires" | splitList " " ) }}
      {{- if ( index $dep . ) }}
        {{- range ( index $dep . ) }}

          {{- range ( include "cr.list_packages_with_deps" . ) | splitList " " }}
            {{- if not (has . $packages) }}
              {{- $packages = . | append $packages }}
            {{- end }}
          {{- end }}

        {{- end }}
      {{- end }}
    {{- end }}

    {{- range ( "prereqs preemerge" | splitList " " ) }}
      {{- if ( index $dep . ) }}
        {{- range ( index $dep . ) }}

          {{- $required := printf "\"%s\"" . }}
          
          {{- if not (has $required $packages) }}
            {{- $packages = $required | append $packages }}
          {{- end }}

        {{- end }}
      {{- end }}
    {{- end }}

    {{- $package := printf "\"%s-%s\"" .category .name }}
    {{- if not (has $package $packages) }}
      {{- $packages = $package | append $packages }}
    {{- end }}

    {{- /*$packages = $packages | uniq */}}
    {{- join " " $packages }}

  {{- else }}
    {{- "" }}
  {{- end }}

{{- end }}

################################################################################
## cr.map_packages_with_deps ###
################################################################################

{{- define "cr.map_packages_with_deps" }}

  {{- $packages := dict }}
  
  {{- if not (default .skip false) }}
  
    {{- $package := . }}
    {{- $requiredBy := printf "%s-%s" .category .name }}
    
    {{- range ("requires prerequires optrequires" | splitList " ") }}
      {{- if ( index $package . ) }}
        {{- range ( index $package . ) }}

          {{- $required := printf "%s-%s" .category .name }}

          {{- range $k, $v := ( ( include "cr.map_packages_with_deps" . ) | fromJson ) }}
            {{- $_ := set $packages $k $v }}
          {{- end }}

          {{- if not ( hasKey $packages $required ) }}
            {{- $_ := set $packages $required $requiredBy }}
          {{- end }}

        {{- end }}
      {{- end }}
    {{- end }}

    {{- range ("prereqs preemerge" | splitList " ") }}
      {{- if ( index $package . ) }}
        {{- range ( index $package . ) }}
        
          {{- $required := printf "\"%s\"" . }}

          {{- if not ( hasKey $packages $required ) }}
            {{- $_ := set $packages $required $requiredBy }}
          {{- end }}

        {{- end }}
      {{- end }}
    {{- end }}

  {{- end }}
  
  {{- $packages | toJson }}

{{- end }}

################################################################################
## cr.copy_package_setup_files ###
################################################################################

{{- define "cr.copy_package_setup_files" }}
{{- $package := . }}
set -x; \
mkdir -p /etc/portage/package.accept_keywords; \
if [ -e "package.accept_keywords/{{ $package }}.accept_keywords" ]; then \
cp -rf package.accept_keywords/{{ $package }}.accept_keywords /etc/portage/package.accept_keywords/{{ $package }}.accept_keywords; \
fi; \
mkdir -p /etc/portage/package.license; \
if [ -e "package.license/{{ $package }}.license" ]; then \
cp -rf package.license/{{ $package }}.license /etc/portage/package.license/{{ $package }}.license; \
fi; \
mkdir -p /etc/portage/package.unmask; \
if [ -e "package.unmask/{{ $package }}.unmask" ]; then \
cp -rf package.unmask/{{ $package }}.unmask /etc/portage/package.unmask/{{ $package }}.unmask; \
fi; \
mkdir -p /etc/portage/package.use; \
if [ -e "package.use/{{ $package }}.use" ]; then \
cp -rf package.use/{{ $package }}.use /etc/portage/package.use/{{ $package }}.use; \
fi;
{{- end }}


################################################################################
## cr.package_setup ###
################################################################################

{{- define "cr.package_setup" }}

{{- $command := "" }}

{{- $command = ( include "cr.copy_package_setup_files" ( printf "%s-%s" ( .category | replace "layerbase" "layers" | replace "buildbase" "layers" ) .name ) | trim ) }}

{{- if .atoms }}

{{- $filepath := "/etc/portage/package" }}
{{- $filename := printf "%s-%s" .category .name }}

{{- range .atoms }}

{{- $atom := . }}

{{- range ("accept_keywords license use" | splitList " ") }}

{{- $command = printf "%sfind %s.%s/ -type f -a \\( -name \"*.%s\" \\) -a -exec sed -i -e \"/%s/d\" {} +; \\\n" $command $filepath . . ( $atom.atom | replace "/" "\\/" ) }}

{{- $value := ( index $atom . ) }}

{{- if $value }}
{{- $command = printf "%smkdir -p %s.%s; \\\n" $command $filepath . }}
{{- $command = printf "%secho -e \"%s %s\" >> %s.%s/%s.%s; \\\n" $command $atom.atom ( $value | replace "\n" "\\n" ) $filepath . $filename . }}
{{- end }}

{{- end }}

{{- range ("unmask" | splitList " ") }}

{{- if (index $atom .) }}
{{- $command = printf "%smkdir -p %s.%s; \\\n" $command $filepath . }}
{{- $command = printf "%secho -e \"\\\"%s\\\" >> %s.%s/%s.%s; \\\n" $command $atom.atom $filepath . $filename . }}
{{- end }}

{{- end }}

{{- $value := (index $atom "env") }}

{{- if $value }}
{{- $command = printf "%smkdir -p /etc/portage/env; \\\n" $command }}
{{- $command = printf "%secho -e \"%s\" >> /etc/portage/env/%s.conf; \\\n" $command ( $value | replace "\n" "\\n" | replace "$" "\\$" | replace "\"" "\\\"" ) $filename }}
{{- $command = printf "%secho -e \"%s %s.conf\" >> /etc/portage/package.env/%s.env; \\\n" $command $atom.atom $filename $filename }}
{{- end }}

{{- $value := (index $atom "env_profile" ) }}

{{- if $value }}
{{- $command = printf "%smkdir -p /etc/portage/env; \\\n" $command }}
{{- $command = printf "%secho -e \"%s %s\" >> /etc/portage/package.env/%s.env; \\\n" $command $atom.atom $value $filename }}
{{- end }}

{{- end }}

{{- $command = printf "%secho;" $command }}

{{- end }}

{{- $command }}

{{- end }}

################################################################################
## cr.prereqs ###
################################################################################

{{- define "cr.prereqs" }}

{{- $packages := index . 1 }}
{{- $previous_package := index . 2 }}

{{- $commands := list }}

{{- with index . 0 }}

{{- if not (default .skip false) }}

{{- $current_package := printf "%s-%s" .category .name }}

{{- $command := "" }}

{{- $enqueue := or ( not $previous_package ) ( eq ( get $packages $current_package ) $previous_package ) }}

{{- if $enqueue }}
{{- $commands = append $commands ( printf "echo \"cr.prereqs (%s required by %s)\"" $current_package ( $previous_package | default "itself" ) ) }}
{{- else }}
{{- $commands = append $commands ( printf "echo \"cr.prereqs (%s required by %s, skipping, should be required by %s)\"" $current_package ( $previous_package | default "itself" ) ( get $packages $current_package ) ) }}
{{- end }}

{{- if $enqueue }}

{{- $package := . }}

{{- if .requires }}
{{- range .requires }}

{{- range include "cr.prereqs_emerge" ( list . $packages $current_package ) | fromJsonArray }}
{{- if . }}
{{- /*if not (has . $commands) */}}
{{- $commands = append $commands . }}
{{- /*end */}}
{{- end }}
{{- end }}

{{- end }}
{{- end }}

{{- range ("prerequires optrequires" | splitList " ") }}
{{- if ( index $package . ) }}
{{- range ( index $package . ) }}

{{- range include "cr.prereqs_emerge" ( list . $packages $current_package ) | fromJsonArray }}
{{- if . }}
{{- /*if not (has . $commands) */}}
{{- $commands = append $commands . }}
{{- /*end */}}
{{- end }}
{{- end }}

{{- end }}
{{- end }}
{{- end }}

{{- if .overlays }}
{{- $command := printf "USE=\"-subversion -mercurial\" emerge app-portage/layman" }}
{{- /*if not (has $command $commands) */}}
{{- $commands = append $commands $command }}
{{- /*end */}}
{{- $command := printf "layman -L" }}
{{- /*if not (has $command $commands) */}}
{{- $commands = append $commands $command }}
{{- /*end */}}
{{- range .overlays }}
{{- if .url }}
{{- $command = printf "echo \"y\" | layman -o %s -f -a %s" .url .name }}
{{- else }}
{{- $command = printf "echo \"y\" | layman -a %s" .name }}
{{- end }}
{{- /*if not (has $command $commands) */}}
{{- $commands = append $commands $command }}
{{- /*end */}}
{{- end }}
{{- end }}

{{- if .prepare }}
{{- range .prepare }}
{{- if . }}
{{- /*if not (has . $commands) */}}
{{- $commands = append $commands . }}
{{- /*end */}}
{{- end }}
{{- end }}
{{- end }}

{{- if .prereqs }}
{{- range .prereqs }}
{{- $command := include "cr.emerge" . }}
{{- if $command }}
{{- /*if not (has $command $commands) */}}
{{- $commands = append $commands $command }}
{{- /*end */}}
{{- end }}
{{- end }}
{{- end }}

{{- if .ready }}
{{- range .ready }}
{{- if . }}
{{- /*if not (has . $commands) */}}
{{- $commands = append $commands . }}
{{- /*end */}}
{{- end }}
{{- end }}
{{- end }}

{{- end }}

{{- end }}

{{- end }}

{{- $commands | toJson }}

{{- end }}

################################################################################
## cr.prereqs_emerge ###
################################################################################

{{- define "cr.prereqs_emerge" }}

{{- $packages := index . 1 }}
{{- $previous_package := index . 2 }}

{{- $commands := list }}

{{- with index . 0 }}

{{- if not (default .skip false) }}

{{- $current_package := printf "%s-%s" .category .name }}

{{- $command := "" }}

{{- $enqueue := or ( not $previous_package ) ( eq ( get $packages $current_package ) $previous_package ) }}

{{- if $enqueue }}
{{- $commands = append $commands ( printf "echo \"cr.prereqs_emerge (%s required by %s)\"" $current_package ( $previous_package | default "itself" ) ) }}
{{- else }}
{{- $commands = append $commands ( printf "echo \"cr.prereqs_emerge (%s required by %s, skipping, should be required by %s)\"" $current_package ( $previous_package | default "itself" ) ( get $packages $current_package ) ) }}
{{- end }}

{{- if $enqueue }}

{{- range include "cr.prereqs" ( list . $packages $previous_package ) | fromJsonArray }}
{{- if . }}
{{- /*if not (has . $commands) */}}
{{- $commands = append $commands . }}
{{- /*end */}}
{{- end }}
{{- end }}

{{- range include "cr.emerge_atom" ( list . $packages $previous_package ) | fromJsonArray }}
{{- if . }}
{{- /*if not (has . $commands) */}}
{{- $commands = append $commands . }}
{{- /*end */}}
{{- end }}
{{- end }}

{{- end }}

{{- end }}

{{- end }}

{{- $commands | toJson }}

{{- end }}

################################################################################
## cr.emerge_atom ###
################################################################################

{{- define "cr.emerge_atom" }}

{{- $packages := index . 1 }}
{{- $previous_package := index . 2 }}

{{- $layerbase_package_setup_only := false }}
{{- if gt ( len . ) 3 }}
  {{- $layerbase_package_setup_only = index . 3 }}
{{- end }}

{{- $commands := list }}

{{- with index . 0 }}

{{- if not (default .skip false) }}

{{- $current_package := printf "%s-%s" .category .name }}

{{- $command := "" }}

{{- if .setup }}
{{- range .setup }}
{{- if . }}
{{- /*if not (has . $commands) */}}
{{- $commands = append $commands . }}
{{- /*end */}}
{{- end }}
{{- end }}
{{- end }}

{{- if .preemerge }}
{{- range .preemerge }}
{{- $command := include "cr.emerge" . }}
{{- if $command }}
{{- /*if not (has $command $commands) */}}
{{- $commands = append $commands $command }}
{{- /*end */}}
{{- end }}
{{- end }}
{{- end }}

{{- if .labels }}
{{- if ( index .labels "emerge.packages" ) }}
{{- $command := include "cr.emerge" ( index .labels "emerge.packages" ) }}
{{- if $command }}
{{- /*if not (has $command $commands) */}}

{{- if or ( not $layerbase_package_setup_only ) ( and ( $layerbase_package_setup_only ) ( eq .category "layerbase" ) ) }}
{{- $package_setup := include "cr.package_setup" . }}
{{- if $package_setup }}
{{- $commands = append $commands $package_setup }}
{{- end }}
{{- end }}

{{- $commands = append $commands $command }}
{{- /*end */}}
{{- end }}
{{- end }}
{{- end }}

{{ if .unmerge }}
{{ range .unmerge }}
- emerge -C {{ . }}
{{ end }}
{{ end }}
{{ if .etc_update }}
{{ if .etc_update.mode }}
- etc-update -q --automode {{ .etc_update.mode }}
{{ end }}
{{ end }}

{{- if .completion }}
{{- range .completion }}
{{- if . }}
{{- /*if not (has . $commands) */}}
{{- $commands = append $commands . }}
{{- /*end */}}
{{- end }}
{{- end }}
{{- end }}

{{- end }}

{{- end }}

{{- $commands | toJson }}

{{- end }}

################################################################################
## cr.emerge ###
################################################################################

{{- define "cr.emerge" }}

{{- $command := "" }}

{{- $tokens := . | splitList ";" }}
{{- if eq (len $tokens) 1 }}
{{- $command = printf "emerge -1 -j ${JOBS} %s" (printf "\"%s\"" ((index $tokens 0) | replace " " "\" \"")) }}
{{- else if eq (len $tokens) 2 }}
{{- $command = printf "%s emerge -1 -j ${JOBS} %s" (index $tokens 1) (printf "\"%s\"" ((index $tokens 0) | replace " " "\" \"")) }}
{{- end }}

{{- $command }}

{{- end }}

################################################################################
## flatten ###
################################################################################

{{- define "cr.flatten_list" -}}
  {{- $output := list -}}
  {{- range . -}}
    {{- if (kindIs "slice" . ) -}}
      {{- $output = (concat $output ( get (fromYaml (include "cr.flatten_list" . ) )  "list" ) ) -}}
    {{- else -}}
      {{- $output = (append $output . ) -}}
    {{- end -}}
  {{- end -}}
  {{- toYaml (dict "list" $output) -}}
{{- end -}}

{{- define "cr.flatten" -}}
  {{- get ( fromYaml (include "cr.flatten_list" . ) ) "list"  | toYaml }}
{{- end -}}

{{- define "cr.flatten_map" -}}
  {{- $map := first . -}}
  {{- $label := last . -}}
  {{- range $key, $val := $map -}}
    {{- $sublabel := list $label $key | join "_" | upper -}}
    {{- if kindOf $val | eq "map" -}}
      {{- list $val $sublabel | include "cr.flatten_map" -}}
    {{- else -}}
- name: {{ $sublabel | quote }}
  value: {{ $val | quote }}
  {{- end -}}
{{- end -}}
{{- end -}}

################################################################################
## debug ###
################################################################################

{{- define "cr.dump" }}
  {{- . | printf "\nThe output of the dumped var is: \n%s" | fail }}
{{- end }}

{{- define "cr.dumpJson" }}
  {{- . | toPrettyJson | printf "\nThe JSON output of the dumped var is: \n%s" | fail }}
{{- end }}
